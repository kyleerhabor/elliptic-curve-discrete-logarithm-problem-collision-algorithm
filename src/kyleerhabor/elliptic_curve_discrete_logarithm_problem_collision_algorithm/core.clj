(ns kyleerhabor.elliptic-curve-discrete-logarithm-problem-collision-algorithm.core
  (:require
   [clojure.math :refer [ceil sqrt]]
   [clojure.tools.logging :as log]))

(defn point-name [{:keys [x y]
                   :as p}]
  (if (nil? p)
    "O"
    (str "(" x ", " y ")")))

(defn theorem-name [{:keys [a b c p pp pq]}]
  (str "C: y^2 = x^3 + " a "x^2 + " b "x + " c ", p = " p ", P = " (point-name pp) ", Q = " (point-name pq)))

(defn square [x]
  (* x x))

(defn mod-inverse [a p]
  (long (.modInverse (biginteger a) (biginteger p))))

(defn add-point [{:keys [a p]}
                 lambda
                 {px :x
                  py :y}
                 {qx :x}]
  (let [;; ν = y_1 − λx_1 = y_2 − λx_2
        nu (mod (- py (* lambda px)) p)
        ;; x_3 = λ^2 - a - x_1 - x_2
        x (mod (- (square lambda) a px qx) p)
        ;; y_3 = -λx_3 - ν
        y (mod (- (- (* lambda x)) nu) p)]
    {:x x
     :y y}))

(defn add-duplicate [{:keys [a b p]
                      :as ecdlp}
                     {px :x
                      py :y
                      :as pp}
                     pq]
  (let [;; y^2 = f(x) = x^3 + ax^2 + bx + c
        ;; d/dx f(x) = 3x^2 + 2ax + b
        ;; λ = d/dx y | P_0
        ;;   = f'(x_1) / 2y_1
        ;;   = d/dx f(x) / 2y_1
        ;;   = (3x_1^2 + 2ax_1 + b) / 2y_1
        lambda (mod (*
                      (+ (* 3 (square px)) (* 2 a px) b)
                      (mod-inverse (* 2 py) p)) p)]
    (add-point ecdlp lambda pp pq)))

(defn- add-general [{:keys [p]
                     :as ecdlp}
                    {px :x
                     py :y
                     :as pp}
                    {qx :x
                     qy :y
                     :as pq}]
  (let [;; λ = (y_2 - y_1) / (x_2 - x_1)
        lambda (mod (*
                      (- qy py)
                      (mod-inverse (- qx px) p)) p)]
    (add-point ecdlp lambda pp pq)))

(defn add [ecdlp k pp pq]
  (let [point (cond
                (nil? pq) pp
                (= pp pq) (add-duplicate ecdlp pp pq)
                :else (add-general ecdlp pp pq))]
    (log/info (str (theorem-name ecdlp) ": k = " k ", " (point-name pp) " + " (point-name pq) " = " (point-name point)))
    point))

(defn negate [{:keys [x y]}]
  {:x x
   :y (- y)})

(defn theorem [{:keys [p pp pq]
                :as ecdlp}]
  (let [;; 4.28 (Shank's Babystep-Giantstep Algorithm).
        ;;
        ;; Step 1: Let n = ⌈√N⌉ be the smallest integer that is greater than √N.
        ;;
        ;; n doesn't have to equal ⌈√N⌉ for the algorithm to work, but it helps in making it efficient. We can use √p as
        ;; an approximate of √N.
        n (ceil (sqrt p))
        _ (log/info (str (theorem-name ecdlp) ": n = " n))
        baby-step-base (add ecdlp 1 pp nil)
        {:keys [steps latest]} (loop [ks (range 2 (inc n))
                                      r baby-step-base
                                      {:keys [steps]
                                       :as data} {:steps {}
                                                  :latest nil}]
                                 (if-let [k (first ks)]
                                   (let [r (add ecdlp k baby-step-base r)]
                                     (recur (rest ks) r {:steps (assoc steps r k)
                                                         :latest r}))
                                   data))
        giant-step-base (negate latest)
        m (loop [ks (range n)
                 r pq]
            (let [k (first ks)]
              (if-let [a (get steps r)]
                (do
                  (log/info (str (theorem-name ecdlp) ": " a "P = Q - " n " * " k "P"))
                  (long (+ a (* n k))))
                (recur (rest ks) (add ecdlp k giant-step-base r)))))]
    (log/info (str (theorem-name ecdlp) ": " m "P = Q"))
    m))

(defn -main []
  ;; C: y^2 = x^3 + x^2 + x + 1, p = 97, P = (7, 20), Q = (17, 46).
  ;;
  ;; n = 10.0
  ;; k = 1, (7, 20) + O = (7, 20)
  ;; k = 2, (7, 20) + (7, 20) = (71, 70)
  ;; k = 3, (7, 20) + (71, 70) = (17, 51)
  ;; k = 4, (7, 20) + (17, 51) = (69, 40)
  ;; k = 5, (7, 20) + (69, 40) = (52, 75)
  ;; k = 6, (7, 20) + (52, 75) = (84, 26)
  ;; k = 7, (7, 20) + (84, 26) = (8, 87)
  ;; k = 8, (7, 20) + (8, 87) = (11, 3)
  ;; k = 9, (7, 20) + (11, 3) = (90, 66)
  ;; k = 10, (7, 20) + (90, 66) = (87, 35)
  ;; k = 0, (87, -35) + (17, 46) = (1, 2)
  ;; k = 1, (87, -35) + (1, 2) = (61, 96)
  ;; k = 2, (87, -35) + (61, 96) = (80, 93)
  ;; k = 3, (87, -35) + (80, 93) = (8, 87)
  ;; 7P = Q - 10.0 * 4P
  ;; 47P = Q
  (assert (= 47 (theorem {:a 1 :b 1 :c 1
                          :p 97
                          :pp {:x 7 :y 20}
                          :pq {:x 17 :y 46}})))

  ;; (a) C: y^2 = x^3 + x^2 + x + 3, p = 103, P = (7, 14), Q = (8, 22).
  ;;
  ;; n = 11.0
  ;; k = 1, (7, 14) + O = (7, 14)
  ;; k = 2, (7, 14) + (7, 14) = (19, 49)
  ;; k = 3, (7, 14) + (19, 49) = (28, 2)
  ;; k = 4, (7, 14) + (28, 2) = (40, 49)
  ;; k = 5, (7, 14) + (40, 49) = (81, 23)
  ;; k = 6, (7, 14) + (81, 23) = (43, 54)
  ;; k = 7, (7, 14) + (43, 54) = (10, 17)
  ;; k = 8, (7, 14) + (10, 17) = (86, 10)
  ;; k = 9, (7, 14) + (86, 10) = (92, 92)
  ;; k = 10, (7, 14) + (92, 92) = (79, 92)
  ;; k = 11, (7, 14) + (79, 92) = (98, 102)
  ;; k = 0, (98, -102) + (8, 22) = (101, 10)
  ;; k = 1, (98, -102) + (101, 10) = (15, 42)
  ;; k = 2, (98, -102) + (15, 42) = (12, 62)
  ;; k = 3, (98, -102) + (12, 62) = (48, 33)
  ;; k = 4, (98, -102) + (48, 33) = (22, 41)
  ;; k = 5, (98, -102) + (22, 41) = (79, 92)
  ;; 10P = Q - 11.0 * 6P
  ;; 76P = Q
  (assert (= 76 (theorem {:a 1 :b 1 :c 3
                          :p 103
                          :pp {:x 7 :y 14}
                          :pq {:x 8 :y 22}})))

  ;; (b) C: y^2 = x^3 - 2x^2 + 5x + 6, p = 149, P = (11, 16), Q = (110, 46).
  ;;
  ;; n = 13.0
  ;; k = 1, (11, 16) + O = (11, 16)
  ;; k = 2, (11, 16) + (11, 16) = (15, 18)
  ;; k = 3, (11, 16) + (15, 18) = (88, 20)
  ;; k = 4, (11, 16) + (88, 20) = (138, 49)
  ;; k = 5, (11, 16) + (138, 49) = (116, 67)
  ;; k = 6, (11, 16) + (116, 67) = (105, 32)
  ;; k = 7, (11, 16) + (105, 32) = (44, 83)
  ;; k = 8, (11, 16) + (44, 83) = (145, 28)
  ;; k = 9, (11, 16) + (145, 28) = (91, 48)
  ;; k = 10, (11, 16) + (91, 48) = (73, 138)
  ;; k = 11, (11, 16) + (73, 138) = (147, 24)
  ;; k = 12, (11, 16) + (147, 24) = (26, 62)
  ;; k = 13, (11, 16) + (26, 62) = (134, 24)
  ;; k = 0, (134, -24) + (110, 46) = (109, 38)
  ;; k = 1, (134, -24) + (109, 38) = (20, 81)
  ;; k = 2, (134, -24) + (20, 81) = (6, 110)
  ;; k = 3, (134, -24) + (6, 110) = (48, 69)
  ;; k = 4, (134, -24) + (48, 69) = (82, 44)
  ;; k = 5, (134, -24) + (82, 44) = (91, 48)
  ;; 9P = Q - 13.0 * 6P
  ;; 87P = Q
  (assert (= 87 (theorem {:a -2 :b 5 :c 6
                          :p 149
                          :pp {:x 11 :y 16}
                          :pq {:x 110 :y 46}})))

  ;; (c) C: y^2 = x^3 + x^2 + x + 2, p = 10037, P = (8, 7358), Q = (2057, 5437).
  ;;
  ;; n = 101.0
  ;; k = 1, (8, 7358) + O = (8, 7358)
  ;; k = 2, (8, 7358) + (8, 7358) = (1556, 7224)
  ;; k = 3, (8, 7358) + (1556, 7224) = (4579, 4151)
  ;; k = 4, (8, 7358) + (4579, 4151) = (621, 7437)
  ;; k = 5, (8, 7358) + (621, 7437) = (4634, 2967)
  ;; k = 6, (8, 7358) + (4634, 2967) = (92, 5818)
  ;; k = 7, (8, 7358) + (92, 5818) = (4696, 4984)
  ;; k = 8, (8, 7358) + (4696, 4984) = (3400, 7514)
  ;; k = 9, (8, 7358) + (3400, 7514) = (6777, 1551)
  ;; k = 10, (8, 7358) + (6777, 1551) = (4719, 171)
  ;; k = 11, (8, 7358) + (4719, 171) = (4965, 2109)
  ;; k = 12, (8, 7358) + (4965, 2109) = (8091, 3556)
  ;; k = 13, (8, 7358) + (8091, 3556) = (522, 3826)
  ;; k = 14, (8, 7358) + (522, 3826) = (10024, 5620)
  ;; k = 15, (8, 7358) + (10024, 5620) = (2643, 9239)
  ;; k = 16, (8, 7358) + (2643, 9239) = (4265, 2596)
  ;; k = 17, (8, 7358) + (4265, 2596) = (5060, 8783)
  ;; k = 18, (8, 7358) + (5060, 8783) = (2679, 8607)
  ;; k = 19, (8, 7358) + (2679, 8607) = (8989, 2906)
  ;; k = 20, (8, 7358) + (8989, 2906) = (7396, 3924)
  ;; k = 21, (8, 7358) + (7396, 3924) = (4319, 2001)
  ;; k = 22, (8, 7358) + (4319, 2001) = (9290, 6977)
  ;; k = 23, (8, 7358) + (9290, 6977) = (2407, 5882)
  ;; k = 24, (8, 7358) + (2407, 5882) = (2023, 5404)
  ;; k = 25, (8, 7358) + (2023, 5404) = (2876, 1545)
  ;; k = 26, (8, 7358) + (2876, 1545) = (8096, 468)
  ;; k = 27, (8, 7358) + (8096, 468) = (5857, 1494)
  ;; k = 28, (8, 7358) + (5857, 1494) = (4476, 8684)
  ;; k = 29, (8, 7358) + (4476, 8684) = (204, 6)
  ;; k = 30, (8, 7358) + (204, 6) = (1495, 7862)
  ;; k = 31, (8, 7358) + (1495, 7862) = (3547, 1493)
  ;; k = 32, (8, 7358) + (3547, 1493) = (7499, 9027)
  ;; k = 33, (8, 7358) + (7499, 9027) = (9607, 8187)
  ;; k = 34, (8, 7358) + (9607, 8187) = (7137, 4783)
  ;; k = 35, (8, 7358) + (7137, 4783) = (898, 2312)
  ;; k = 36, (8, 7358) + (898, 2312) = (8937, 7043)
  ;; k = 37, (8, 7358) + (8937, 7043) = (6141, 7666)
  ;; k = 38, (8, 7358) + (6141, 7666) = (9129, 1167)
  ;; k = 39, (8, 7358) + (9129, 1167) = (5076, 5418)
  ;; k = 40, (8, 7358) + (5076, 5418) = (2575, 8288)
  ;; k = 41, (8, 7358) + (2575, 8288) = (2026, 2769)
  ;; k = 42, (8, 7358) + (2026, 2769) = (1614, 1994)
  ;; k = 43, (8, 7358) + (1614, 1994) = (8133, 5680)
  ;; k = 44, (8, 7358) + (8133, 5680) = (592, 6912)
  ;; k = 45, (8, 7358) + (592, 6912) = (7060, 90)
  ;; k = 46, (8, 7358) + (7060, 90) = (5799, 4480)
  ;; k = 47, (8, 7358) + (5799, 4480) = (6044, 8776)
  ;; k = 48, (8, 7358) + (6044, 8776) = (6000, 400)
  ;; k = 49, (8, 7358) + (6000, 400) = (4154, 36)
  ;; k = 50, (8, 7358) + (4154, 36) = (2394, 9701)
  ;; k = 51, (8, 7358) + (2394, 9701) = (463, 1597)
  ;; k = 52, (8, 7358) + (463, 1597) = (4221, 3212)
  ;; k = 53, (8, 7358) + (4221, 3212) = (903, 1418)
  ;; k = 54, (8, 7358) + (903, 1418) = (1161, 2369)
  ;; k = 55, (8, 7358) + (1161, 2369) = (8250, 9911)
  ;; k = 56, (8, 7358) + (8250, 9911) = (3160, 631)
  ;; k = 57, (8, 7358) + (3160, 631) = (1017, 161)
  ;; k = 58, (8, 7358) + (1017, 161) = (2864, 380)
  ;; k = 59, (8, 7358) + (2864, 380) = (6641, 8785)
  ;; k = 60, (8, 7358) + (6641, 8785) = (281, 6547)
  ;; k = 61, (8, 7358) + (281, 6547) = (3947, 42)
  ;; k = 62, (8, 7358) + (3947, 42) = (1136, 4453)
  ;; k = 63, (8, 7358) + (1136, 4453) = (4683, 5972)
  ;; k = 64, (8, 7358) + (4683, 5972) = (5937, 9349)
  ;; k = 65, (8, 7358) + (5937, 9349) = (2377, 4416)
  ;; k = 66, (8, 7358) + (2377, 4416) = (7015, 7627)
  ;; k = 67, (8, 7358) + (7015, 7627) = (8722, 3923)
  ;; k = 68, (8, 7358) + (8722, 3923) = (1746, 2286)
  ;; k = 69, (8, 7358) + (1746, 2286) = (7528, 6029)
  ;; k = 70, (8, 7358) + (7528, 6029) = (6433, 6584)
  ;; k = 71, (8, 7358) + (6433, 6584) = (3339, 4116)
  ;; k = 72, (8, 7358) + (3339, 4116) = (4266, 4033)
  ;; k = 73, (8, 7358) + (4266, 4033) = (2212, 7092)
  ;; k = 74, (8, 7358) + (2212, 7092) = (1249, 233)
  ;; k = 75, (8, 7358) + (1249, 233) = (9989, 287)
  ;; k = 76, (8, 7358) + (9989, 287) = (527, 9735)
  ;; k = 77, (8, 7358) + (527, 9735) = (3766, 6083)
  ;; k = 78, (8, 7358) + (3766, 6083) = (4711, 36)
  ;; k = 79, (8, 7358) + (4711, 36) = (9440, 8146)
  ;; k = 80, (8, 7358) + (9440, 8146) = (5310, 4475)
  ;; k = 81, (8, 7358) + (5310, 4475) = (1079, 6879)
  ;; k = 82, (8, 7358) + (1079, 6879) = (3946, 8948)
  ;; k = 83, (8, 7358) + (3946, 8948) = (10027, 2620)
  ;; k = 84, (8, 7358) + (10027, 2620) = (3241, 7057)
  ;; k = 85, (8, 7358) + (3241, 7057) = (4967, 4783)
  ;; k = 86, (8, 7358) + (4967, 4783) = (472, 7733)
  ;; k = 87, (8, 7358) + (472, 7733) = (7466, 5780)
  ;; k = 88, (8, 7358) + (7466, 5780) = (8889, 7247)
  ;; k = 89, (8, 7358) + (8889, 7247) = (5276, 4639)
  ;; k = 90, (8, 7358) + (5276, 4639) = (3029, 9674)
  ;; k = 91, (8, 7358) + (3029, 9674) = (159, 7198)
  ;; k = 92, (8, 7358) + (159, 7198) = (7751, 6430)
  ;; k = 93, (8, 7358) + (7751, 6430) = (9567, 1306)
  ;; k = 94, (8, 7358) + (9567, 1306) = (3454, 8142)
  ;; k = 95, (8, 7358) + (3454, 8142) = (1299, 294)
  ;; k = 96, (8, 7358) + (1299, 294) = (1087, 3685)
  ;; k = 97, (8, 7358) + (1087, 3685) = (6359, 2922)
  ;; k = 98, (8, 7358) + (6359, 2922) = (5324, 2822)
  ;; k = 99, (8, 7358) + (5324, 2822) = (9218, 1996)
  ;; k = 100, (8, 7358) + (9218, 1996) = (3179, 6611)
  ;; k = 101, (8, 7358) + (3179, 6611) = (9945, 3643)
  ;; k = 0, (9945, -3643) + (2057, 5437) = (8753, 2902)
  ;; k = 1, (9945, -3643) + (8753, 2902) = (3266, 3910)
  ;; k = 2, (9945, -3643) + (3266, 3910) = (6435, 2284)
  ;; k = 3, (9945, -3643) + (6435, 2284) = (9368, 5777)
  ;; k = 4, (9945, -3643) + (9368, 5777) = (8969, 3469)
  ;; k = 5, (9945, -3643) + (8969, 3469) = (3720, 6904)
  ;; k = 6, (9945, -3643) + (3720, 6904) = (8396, 4677)
  ;; k = 7, (9945, -3643) + (8396, 4677) = (7465, 5109)
  ;; k = 8, (9945, -3643) + (7465, 5109) = (333, 610)
  ;; k = 9, (9945, -3643) + (333, 610) = (7804, 2538)
  ;; k = 10, (9945, -3643) + (7804, 2538) = (2863, 2798)
  ;; k = 11, (9945, -3643) + (2863, 2798) = (2377, 4416)
  ;; 65P = Q - 101.0 * 12P
  ;; 1277P = Q
  (assert (= 1277 (theorem {:a 1 :b 1 :c 2
                            :p 10037
                            :pp {:x 8 :y 7358}
                            :pq {:x 2057 :y 5437}}))))
